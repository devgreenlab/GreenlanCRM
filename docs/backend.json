{
  "entities": {
    "Team": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Team",
      "type": "object",
      "description": "Represents a team within the Greenlab CRM.",
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the team."
        },
        "headSalesUid": {
          "type": "string",
          "description": "The user ID of the Head of Sales for this team."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        }
      },
      "required": ["name"]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the Greenlab CRM.",
      "properties": {
        "name": {
          "type": "string",
          "description": "Full name of the user."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user, used as a unique identifier/username."
        },
        "role": {
          "type": "string",
          "description": "Role of the user.",
          "enum": ["SUPER_ADMIN", "HEAD_SALES", "SALES"]
        },
        "teamId": {
          "type": "string",
          "description": "The ID of the team this user belongs to."
        },
        "isActive": {
          "type": "boolean",
          "description": "Whether the user account is active."
        },
        "createdAt": {
            "type": "string",
            "format": "date-time"
        },
        "updatedAt": {
            "type": "string",
            "format": "date-time"
        }
      },
      "required": ["name", "email", "role", "isActive"]
    },
    "Contact": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Contact",
      "type": "object",
      "description": "Represents a contact in the CRM.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the contact." },
        "teamId": { "type": "string", "description": "The ID of the team this contact belongs to." },
        "firstName": { "type": "string", "description": "First name of the contact." },
        "lastName": { "type": "string", "description": "Last name of the contact." },
        "email": { "type": "string", "description": "Email address of the contact.", "format": "email" },
        "phone": { "type": "string", "description": "Phone number of the contact." },
        "company": { "type": "string", "description": "Company the contact works for." },
        "title": { "type": "string", "description": "Job title of the contact." }
      },
      "required": ["id", "teamId", "firstName", "lastName", "email"]
    },
    "Lead": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Lead",
      "type": "object",
      "description": "Represents a lead in the CRM.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the lead." },
        "teamId": { "type": "string", "description": "The ID of the team this lead belongs to." },
        "contactId": { "type": "string", "description": "Reference to Contact. (Relationship: Contact 1:N Lead)" },
        "source": { "type": "string", "description": "Source of the lead (e.g., website, referral, advertisement)." },
        "stage": { "type": "string", "description": "Current stage of the lead in the sales pipeline (e.g., prospect, qualified, demo, proposal, closed)." },
        "priority": { "type": "string", "description": "Priority of the lead (e.g. high, medium, low)." }
      },
      "required": ["id", "teamId", "contactId", "source", "stage"]
    },
    "Deal": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Deal",
      "type": "object",
      "description": "Represents a deal or opportunity in the CRM.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the deal." },
        "teamId": { "type": "string", "description": "The ID of the team this deal belongs to." },
        "leadId": { "type": "string", "description": "Reference to Lead. (Relationship: Lead 1:N Deal)" },
        "name": { "type": "string", "description": "Name of the deal." },
        "amount": { "type": "number", "description": "Value of the deal." },
        "stage": { "type": "string", "description": "Current stage of the deal in the sales pipeline (e.g., qualification, proposal, negotiation, closed won, closed lost)." },
        "closeDate": { "type": "string", "description": "Expected close date of the deal.", "format": "date-time" }
      },
      "required": ["id", "teamId", "leadId", "name", "amount", "stage", "closeDate"]
    },
    "Activity": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Activity",
      "type": "object",
      "description": "Represents an activity related to a contact, lead, or deal.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the activity." },
        "teamId": { "type": "string", "description": "The ID of the team this activity belongs to." },
        "type": { "type": "string", "description": "Type of activity (e.g., call, email, meeting, task)." },
        "subject": { "type": "string", "description": "Subject of the activity." },
        "description": { "type": "string", "description": "Description of the activity." },
        "dueDate": { "type": "string", "description": "Due date of the activity.", "format": "date-time" },
        "contactId": { "type": "string", "description": "Reference to Contact. (Relationship: Contact 1:N Activity)" },
        "leadId": { "type": "string", "description": "Reference to Lead. (Relationship: Lead 1:N Activity)" },
        "dealId": { "type": "string", "description": "Reference to Deal. (Relationship: Deal 1:N Activity)" }
      },
      "required": ["id", "teamId", "type", "subject", "dueDate"]
    },
    "IntegrationSetting": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "IntegrationSetting",
      "type": "object",
      "description": "Stores the configuration for external integrations like WAHA and n8n.",
      "properties": {
        "waha": {
          "type": "object",
          "properties": {
            "baseUrl": { "type": "string", "format": "uri" },
            "session": { "type": "string" }
          }
        },
        "n8n": {
          "type": "object",
          "properties": {
            "outboundWebhookUrl": { "type": "string", "format": "uri" }
          }
        },
        "secrets": {
          "type": "object",
          "properties": {
            "crmWebhookSecret": { "type": "string" },
            "wahaApiKeyLast4": { "type": "string" },
            "wahaApiKeyRotatedAt": { "type": "string", "format": "date-time" }
          }
        },
        "flags": {
          "type": "object",
          "properties": {
            "inboundEnabled": { "type": "boolean" },
            "outboundEnabled": { "type": "boolean" }
          }
        },
        "updatedAt": { "type": "string", "format": "date-time" },
        "updatedBy": { "type": "string", "description": "UID of the user who last updated the settings." }
      }
    },
    "AuditLog": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "Audit Log",
        "type": "object",
        "description": "Records important actions performed by users, especially admins.",
        "properties": {
            "action": { "type": "string", "enum": ["SAVE_INTEGRATION_SETTINGS", "SET_WAHA_KEY", "CLEAR_WAHA_KEY", "TEST_WAHA_CONNECTION"] },
            "byUid": { "type": "string", "description": "The UID of the user who performed the action." },
            "at": { "type": "string", "format": "date-time" },
            "result": { "type": "string", "enum": ["SUCCESS", "FAILURE"] },
            "message": { "type": "string", "description": "A descriptive message about the event." }
        },
        "required": ["action", "byUid", "at", "result"]
    },
     "NavigationSetting": {
      "title": "Navigation Setting",
      "type": "object",
      "description": "Defines role-based access for sidebar navigation.",
      "properties": {
        "roleAccess": {
          "type": "object",
          "properties": {
            "HEAD_SALES": {
              "type": "array",
              "items": { "type": "string" }
            },
            "SALES": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        }
      }
    },
    "PipelineSetting": {
      "title": "Pipeline Setting",
      "type": "object",
      "description": "Defines the stages for sales pipelines.",
      "properties": {
        "leadStages": {
          "type": "array",
          "description": "The stages for the lead pipeline.",
          "items": { "type": "string" }
        },
        "dealStages": {
          "type": "array",
          "description": "The stages for the deal pipeline.",
          "items": { "type": "string" }
        }
      }
    }
  },
  "auth": {
    "providers": [
      "password"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/teams/{teamId}",
        "definition": { "schema": { "$ref": "#/entities/Team" }, "description": "Stores team information." }
      },
      {
        "path": "/users/{userId}",
        "definition": { "schema": { "$ref": "#/entities/User" }, "description": "Stores user information." }
      },
      {
        "path": "/contacts/{contactId}",
        "definition": { "schema": { "$ref": "#/entities/Contact" }, "description": "Stores contact information." }
      },
      {
        "path": "/leads/{leadId}",
        "definition": { "schema": { "$ref": "#/entities/Lead" }, "description": "Stores lead information." }
      },
      {
        "path": "/deals/{dealId}",
        "definition": { "schema": { "$ref": "#/entities/Deal" }, "description": "Stores deal information." }
      },
      {
        "path": "/activities/{activityId}",
        "definition": { "schema": { "$ref": "#/entities/Activity" }, "description": "Stores activity information." }
      },
      {
        "path": "/settings/navigation",
        "definition": { "schema": { "$ref": "#/entities/NavigationSetting" }, "description": "Stores role-based access control settings for the UI navigation." }
      },
       {
        "path": "/settings/pipeline",
        "definition": { "schema": { "$ref": "#/entities/PipelineSetting" }, "description": "Stores the configuration for sales pipeline stages." }
      },
      {
        "path": "/integrations/settings",
        "definition": { "schema": { "$ref": "#/entities/IntegrationSetting" }, "description": "Stores public integration settings and metadata about secrets." }
      },
      {
        "path": "/audit_logs/{logId}",
        "definition": { "schema": { "$ref": "#/entities/AuditLog" }, "description": "Stores audit logs for important admin actions." }
      }
    ],
    "reasoning": "This Firestore structure is designed to support a Greenlab CRM application. The entities cover all core aspects of a CRM: teams, users, contacts, leads, deals, and activities. It also includes settings for pipelines and integrations, and a collection for logs. For a public demo, security rules are temporarily relaxed to allow public read access, but the data model includes 'teamId' on relevant entities to facilitate a straightforward transition to a multi-tenant security model once user authentication is implemented. This structure avoids complex joins by keeping related data in separate top-level collections, which is efficient for Firestore queries."
  }
}
