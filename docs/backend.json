{
  "entities": {
    "Team": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Team",
      "type": "object",
      "description": "Represents a team within the Greenlab CRM.",
      "properties": {
        "name": { "type": "string", "description": "Name of the team." },
        "headSalesUid": { "type": "string", "description": "The user ID of the Head of Sales for this team." },
        "createdAt": { "type": "string", "format": "date-time" }
      },
      "required": ["name"]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the Greenlab CRM.",
      "properties": {
        "name": { "type": "string", "description": "Full name of the user." },
        "email": { "type": "string", "description": "Email address of the user, used as a unique identifier/username." },
        "role": { "type": "string", "description": "Role of the user.", "enum": ["SUPER_ADMIN", "HEAD_SALES", "SALES"] },
        "teamId": { "type": "string", "description": "The ID of the team this user belongs to." },
        "isActive": { "type": "boolean", "description": "Whether the user account is active." },
        "wahaSession": { "type": "string", "description": "The user's dedicated WAHA session name (for Sales roles)." },
        "waNumber": { "type": "string", "description": "The user's WhatsApp number for display purposes." },
        "createdAt": { "type": "string", "format": "date-time" },
        "updatedAt": { "type": "string", "format": "date-time" }
      },
      "required": ["name", "email", "role", "isActive"]
    },
    "Contact": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Contact",
      "type": "object",
      "description": "Represents a contact in the CRM.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the contact." },
        "teamId": { "type": "string", "description": "The ID of the team this contact belongs to." },
        "firstName": { "type": "string", "description": "First name of the contact." },
        "lastName": { "type": "string", "description": "Last name of the contact." },
        "email": { "type": "string", "description": "Email address of the contact.", "format": "email" },
        "phone": { "type": "string", "description": "Phone number of the contact." },
        "company": { "type": "string", "description": "Company the contact works for." },
        "title": { "type": "string", "description": "Job title of the contact." }
      },
      "required": ["id", "teamId", "firstName", "lastName", "email"]
    },
    "Lead": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Lead",
      "type": "object",
      "description": "Represents a lead in the CRM, often originating from a chat.",
      "properties": {
        "id": { "type": "string" },
        "ownerUid": { "type": "string" },
        "teamId": { "type": "string" },
        "source": { "type": "string", "enum": ["whatsapp", "web", "manual"] },
        "customerName": { "type": "string" },
        "phone": { "type": "string" },
        "chatId": { "type": "string", "description": "The unique identifier for the chat, e.g., 62812...@c.us for WhatsApp." },
        "wahaSession": { "type": "string", "description": "The WAHA session of the assigned sales agent." },
        "stage": { "type": "string" },
        "lastMessageAt": { "type": "string", "format": "date-time", "description": "Timestamp of the last message (in or out)." },
        "lastMessagePreview": { "type": "string", "description": "A snippet of the last message sent or received." },
        "unreadCount": { "type": "number", "description": "Number of unread messages for the sales agent." }
      },
      "required": ["id", "ownerUid", "teamId", "source", "customerName", "phone", "chatId", "wahaSession", "stage"]
    },
     "Message": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Message",
      "type": "object",
      "description": "Represents a single message in a chat with a lead.",
      "properties": {
        "direction": { "type": "string", "enum": ["in", "out"], "description": "Indicates if the message was inbound or outbound." },
        "text": { "type": "string", "description": "The content of the message." },
        "session": { "type": "string", "description": "The WAHA session that handled the message." },
        "timestamp": { "type": "string", "format": "date-time" },
        "actorUid": { "type": "string", "description": "For outbound messages, the UID of the CRM user who sent it." },
        "status": { "type": "string", "enum": ["sent", "delivered", "read", "failed"], "description": "The delivery status of the message." },
        "raw": { "type": "object", "description": "The raw, unprocessed payload from the webhook for debugging." }
      },
      "required": ["direction", "text", "timestamp"]
    },
    "Deal": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Deal",
      "type": "object",
      "description": "Represents a deal or opportunity in the CRM.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the deal." },
        "teamId": { "type": "string", "description": "The ID of the team this deal belongs to." },
        "leadId": { "type": "string", "description": "Reference to Lead. (Relationship: Lead 1:N Deal)" },
        "name": { "type": "string", "description": "Name of the deal." },
        "amount": { "type": "number", "description": "Value of the deal." },
        "stage": { "type": "string", "description": "Current stage of the deal in the sales pipeline (e.g., qualification, proposal, negotiation, closed won, closed lost)." },
        "closeDate": { "type": "string", "description": "Expected close date of the deal.", "format": "date-time" }
      },
      "required": ["id", "teamId", "leadId", "name", "amount", "stage", "closeDate"]
    },
    "Activity": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Activity",
      "type": "object",
      "description": "Represents a non-chat activity related to a contact, lead, or deal.",
      "properties": {
        "id": { "type": "string" },
        "leadId": { "type": "string" },
        "teamId": { "type": "string" },
        "actorUid": { "type": "string" },
        "type": { "type": "string", "enum": ["call", "meeting", "note"] },
        "content": { "type": "string" }
      },
      "required": ["id", "teamId", "actorUid", "type", "content"]
    },
    "IntegrationSetting": {
      "title": "Integration Setting",
      "description": "Stores the configuration for external integrations like WAHA.",
      "type": "object",
      "properties": {
        "waha": {
          "type": "object",
          "properties": {
            "baseUrl": { "type": "string", "format": "uri" }
          }
        },
        "secrets": {
          "type": "object",
          "properties": {
            "crmWebhookSecret": { "type": "string" },
            "wahaApiKeyLast4": { "type": "string" },
            "wahaApiKeyRotatedAt": { "type": "string", "format": "date-time" }
          }
        },
        "flags": {
          "type": "object",
          "properties": {
            "inboundEnabled": { "type": "boolean" },
            "outboundEnabled": { "type": "boolean" },
            "captureFromNow": { "type": "boolean", "description": "If true, ignore webhook events for messages sent before the service was started."}
          }
        },
        "updatedAt": { "type": "string", "format": "date-time" },
        "updatedBy": { "type": "string", "description": "UID of the user who last updated the settings." }
      }
    },
    "AuditLog": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "Audit Log",
        "type": "object",
        "description": "Records important actions performed by users, especially admins.",
        "properties": {
            "action": { "type": "string", "enum": ["SAVE_INTEGRATION_SETTINGS", "SET_WAHA_KEY", "CLEAR_WAHA_KEY", "TEST_WAHA_CONNECTION", "SEND_WA_ATTEMPT", "SEND_WA_SUCCESS", "SEND_WA_FAIL", "WAHA_SESSION_START", "WAHA_SESSION_STOP", "WAHA_SESSION_LOGOUT", "WAHA_SESSION_STATUS", "INBOUND_WA_RECEIVED", "INBOUND_WA_FAILED"] },
            "byUid": { "type": "string", "description": "The UID of the user who performed the action." },
            "at": { "type": "string", "format": "date-time" },
            "result": { "type": "string", "enum": ["SUCCESS", "FAILURE"] },
            "message": { "type": "string", "description": "A descriptive message about the event." }
        },
        "required": ["action", "byUid", "at", "result"]
    },
     "NavigationSetting": {
      "title": "Navigation Setting",
      "type": "object",
      "description": "Defines role-based access for sidebar navigation.",
      "properties": {
        "roleAccess": {
          "type": "object",
          "properties": {
            "SUPER_ADMIN": { "type": "array", "items": { "type": "string" } },
            "HEAD_SALES": { "type": "array", "items": { "type": "string" } },
            "SALES": { "type": "array", "items": { "type": "string" } }
          }
        }
      }
    },
    "PipelineSetting": {
      "title": "Pipeline Setting",
      "type": "object",
      "description": "Defines the stages for sales pipelines.",
      "properties": {
        "leadStages": { "type": "array", "description": "The stages for the lead pipeline.", "items": { "type": "string" } },
        "dealStages": { "type": "array", "description": "The stages for the deal pipeline.", "items": { "type": "string" } }
      }
    }
  },
  "auth": {
    "providers": [
      "password"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/teams/{teamId}",
        "definition": { "schema": { "$ref": "#/entities/Team" }, "description": "Stores team information." }
      },
      {
        "path": "/users/{userId}",
        "definition": { "schema": { "$ref": "#/entities/User" }, "description": "Stores user information." }
      },
      {
        "path": "/contacts/{contactId}",
        "definition": { "schema": { "$ref": "#/entities/Contact" }, "description": "Stores contact information." }
      },
      {
        "path": "/leads/{leadId}",
        "definition": { "schema": { "$ref": "#/entities/Lead" }, "description": "Stores lead information." }
      },
      {
        "path": "/leads/{leadId}/messages/{messageId}",
        "definition": { "schema": { "$ref": "#/entities/Message" }, "description": "Stores the chat history for a specific lead." }
      },
      {
        "path": "/deals/{dealId}",
        "definition": { "schema": { "$ref": "#/entities/Deal" }, "description": "Stores deal information." }
      },
      {
        "path": "/activities/{activityId}",
        "definition": { "schema": { "$ref": "#/entities/Activity" }, "description": "Stores non-chat activity information." }
      },
      {
        "path": "/settings/navigation",
        "definition": { "schema": { "$ref": "#/entities/NavigationSetting" }, "description": "Stores role-based access control settings for the UI navigation." }
      },
       {
        "path": "/settings/pipeline",
        "definition": { "schema": { "$ref": "#/entities/PipelineSetting" }, "description": "Stores the configuration for sales pipeline stages." }
      },
      {
        "path": "/integrations/settings",
        "definition": { "schema": { "$ref": "#/entities/IntegrationSetting" }, "description": "Stores public integration settings and metadata about secrets." }
      },
      {
        "path": "/audit_logs/{logId}",
        "definition": { "schema": { "$ref": "#/entities/AuditLog" }, "description": "Stores audit logs for important admin actions." }
      }
    ],
    "reasoning": "This Firestore structure is designed to support a Greenlab CRM application. The entities cover all core aspects of a CRM: teams, users, contacts, leads, deals, and activities. It now includes a subcollection for messages under each lead to properly store chat history. It also includes settings for pipelines and integrations, and a collection for logs. Security rules will ensure data is accessed only by authorized roles."
  }
}
