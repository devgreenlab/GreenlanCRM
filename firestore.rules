rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getRequestingUser() {
      // Use exists() for safe access
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isSuperAdmin() {
      // Check for existence and role
      return isSignedIn() && getRequestingUser().data.role == 'SUPER_ADMIN';
    }
    
    function isHeadSales() {
        return isSignedIn() && getRequestingUser().data.role == 'HEAD_SALES';
    }

    function isSales() {
        return isSignedIn() && getRequestingUser().data.role == 'SALES';
    }
    
    // Check if the requesting user is active
    function isActive() {
        return isSignedIn() && getRequestingUser().data.isActive == true;
    }

    function userTeamId() {
        return getRequestingUser().data.teamId;
    }

    // --- Core Collections ---
    match /users/{userId} {
      // Users can read their own profile. Super Admins can read anyone's profile.
      allow get: if isActive() && (request.auth.uid == userId || isSuperAdmin());
      
      // Any active, signed-in user can see a list of other users (for assigning tasks, etc.).
      allow list: if isActive();
      
      // Only Super Admins can create/update/delete users.
      allow write: if isSuperAdmin();
    }

    match /teams/{teamId} {
      // Any active, signed-in user can read team data.
      allow read: if isActive();
      // Only Super Admins can create/update teams.
      allow write: if isSuperAdmin();
    }

    // --- Settings & System Collections ---
    match /settings/{docId} {
      // Allow reading for specific public docs, otherwise require admin for read.
      allow get: if ((docId == 'navigation' || docId == 'pipeline') && isActive()) || isSuperAdmin();
      
      // Writing is always admin-only for any settings document.
      // Listing settings is also admin-only.
      allow list, write: if isSuperAdmin();
    }

    match /integrations/settings {
      // Only Super Admins can manage integration settings.
      allow read, write: if isSuperAdmin();
    }

    // THIS COLLECTION IS SERVER-SIDE ONLY. No client should ever be able to read or write here.
    match /integrations_secrets/{docId} {
      allow read, write: if false;
    }

    match /audit_logs/{logId} {
      // Only Super Admins can review audit logs.
      allow read: if isSuperAdmin();
      // Logs are append-only from the server.
      allow write: if false;
    }

    // --- CRM Data Collections ---
    match /contacts/{contactId} {
        // Super Admins see all. Head Sales/Sales see contacts within their own team.
        allow read: if isActive() && (
            isSuperAdmin() ||
            ( (isHeadSales() || isSales()) && resource.data.teamId == userTeamId() )
        );
        // Super Admins can write anywhere. Others can write if the contact belongs to their team.
        allow write: if isActive() && (
            isSuperAdmin() ||
            ( (isHeadSales() || isSales()) && request.resource.data.teamId == userTeamId() )
        );
    }
    
    match /leads/{leadId} {
        // Super Admins see all. Head Sales see all leads in their team. Sales see only leads they own.
        allow get: if isActive() && (
            isSuperAdmin() ||
            (isHeadSales() && resource.data.teamId == userTeamId()) ||
            (isSales() && resource.data.ownerUid == request.auth.uid)
        );
        // List is available to all active users, but will be filtered by queries on the client.
        allow list: if isActive();
        
        // Writes are allowed if you are an admin or it's in your team.
        // Server-side processes (like inbound webhooks) will bypass these rules.
        allow write: if isActive() && (
            isSuperAdmin() ||
            ( (isHeadSales() || isSales()) && request.resource.data.teamId == userTeamId() )
        );

        // --- Messages Subcollection ---
        match /messages/{messageId} {
          // You can read messages if you can read the parent lead.
          allow read: if get(/databases/$(database)/documents/leads/$(leadId)).data.ownerUid == request.auth.uid ||
                         (isHeadSales() && get(/databases/$(database)/documents/leads/$(leadId)).data.teamId == userTeamId()) ||
                         isSuperAdmin();
          // Messages can only be written by the server (via webhooks or the /api/wa/send endpoint).
          allow write: if false;
        }
    }

    match /deals/{dealId} {
        // Super Admins see all. Head Sales see all deals in their team. Sales see only deals they own.
        allow read: if isActive() && (
            isSuperAdmin() ||
            (isHeadSales() && resource.data.teamId == userTeamId()) ||
            (isSales() && resource.data.ownerUid == request.auth.uid)
        );
        // Super Admins can write anywhere. Others can write if the deal belongs to their team.
        allow write: if isActive() && (
            isSuperAdmin() ||
            ( (isHeadSales() || isSales()) && request.resource.data.teamId == userTeamId() )
        );
    }

    match /activities/{activityId} {
      // Super Admins see all. Head Sales see all activities in their team. 
      // Sales can see activities on leads they own.
      allow read: if isActive() && (
        isSuperAdmin() ||
        (isHeadSales() && resource.data.teamId == userTeamId()) ||
        (isSales() && get(/databases/$(database)/documents/leads/$(resource.data.leadId)).data.ownerUid == request.auth.uid)
      );
      // Activities are written by the server gateway (e.g., /wa/send).
      // Client-side writes could be enabled for specific activity types if needed.
      allow write: if false; 
    }
  }
}
